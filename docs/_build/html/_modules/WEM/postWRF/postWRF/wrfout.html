<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>WEM.postWRF.postWRF.wrfout &mdash; .  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title=".  documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">.  documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for WEM.postWRF.postWRF.wrfout</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;Compute or load data from netCDF file.</span>

<span class="sd">Dimensions of 4D variable X are X.dimensions:</span>
<span class="sd">(Time,bottom_top,south_north,west_east_stag)</span>
<span class="sd">Time, levels, latitude, longitude</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">N</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">constants</span> <span class="kn">as</span> <span class="nn">cc</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>

<span class="kn">import</span> <span class="nn">WEM.utils</span> <span class="kn">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">metconstants</span> <span class="kn">as</span> <span class="nn">mc</span>

<div class="viewcode-block" id="WRFOut"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut">[docs]</a><span class="k">class</span> <span class="nc">WRFOut</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">fpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wrf_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;Times&#39;</span><span class="p">][:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">DX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">DY</span>

        <span class="c">#self.lvs =</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;XLAT&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="c"># Might fail if only one time?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;XLONG&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lats1D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">[:,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lons1D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cen_lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">CEN_LAT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cen_lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">CEN_LON</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truelat1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">TRUELAT1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truelat2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">TRUELAT2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s">&#39;west_east&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s">&#39;south_north&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s">&#39;bottom_top&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">P_top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;P_TOP&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c"># Loads variable lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">computed_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_tbl</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_vrbls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">computed_fields</span>

        <span class="c"># Get times in nicer format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrf_times_epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrftime_to_datenum</span><span class="p">()</span>


<div class="viewcode-block" id="WRFOut.wrftime_to_datenum"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.wrftime_to_datenum">[docs]</a>    <span class="k">def</span> <span class="nf">wrftime_to_datenum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert wrf&#39;s weird Times variable to datenum time.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrf_times</span>
        <span class="n">wrf_times_epoch</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">times</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">tstr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="n">yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tstr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">mth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tstr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
            <span class="n">day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tstr</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">hr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tstr</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">13</span><span class="p">])</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tstr</span><span class="p">[</span><span class="mi">14</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
            <span class="n">sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tstr</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">19</span><span class="p">])</span>

            <span class="n">wrf_times_epoch</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">([</span><span class="n">yr</span><span class="p">,</span><span class="n">mth</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">hr</span><span class="p">,</span><span class="n">mins</span><span class="p">,</span><span class="n">sec</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">wrf_times_epoch</span>

</div>
<div class="viewcode-block" id="WRFOut.get_time_idx"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.get_time_idx">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">utc</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input:</span>

<span class="sd">        utc     :   time, tuple or datenum</span>
<span class="sd">                    can be one or more</span>

<span class="sd">        Output:</span>

<span class="sd">        time_idx    :   index of time in WRF file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ensure_datenum</span><span class="p">(</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">tidx</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">closest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wrf_times_epoch</span><span class="p">,</span><span class="n">dn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tidx</span>

</div>
<div class="viewcode-block" id="WRFOut.check_compute"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.check_compute">[docs]</a>    <span class="k">def</span> <span class="nf">check_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vrbl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method returns the required variables</span>
<span class="sd">        that need to be loaded from the netCDF file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">vrbl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="WRFOut.get"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vrbl</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">lats</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">lons</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">smooth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get data.</span>

<span class="sd">        Will interpolate onto pressure, height coordinates if needed.</span>
<span class="sd">        Will smooth if needed.</span>

<span class="sd">        Will accept the following.</span>
<span class="sd">        Time:</span>
<span class="sd">        indices (&lt;500): integer/N.ndarray of integers</span>
<span class="sd">        time tuple: 6-item tuple or list/tuple of these</span>
<span class="sd">        datenum: integer &gt;500 or list of them</span>

<span class="sd">        Level:</span>
<span class="sd">        indices: integer or N.ndarray of integers</span>
<span class="sd">        pressure: string ending in &#39;hPa&#39;</span>
<span class="sd">        height: string ending in &#39;m&#39; or &#39;km&#39;</span>
<span class="sd">        isentropic: string ending in &#39;K&#39;</span>

<span class="sd">        Lats:</span>
<span class="sd">        indices: integer or N.ndarray of integers</span>
<span class="sd">        lats: float or N.ndarray of floats</span>

<span class="sd">        Lons:</span>
<span class="sd">        indices: integer or N.ndarray of integers</span>
<span class="sd">        lons: float or N.ndarray of floats</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># import pdb; pdb.set_trace()</span>
        <span class="c"># Time</span>
        <span class="k">if</span> <span class="n">utc</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">tidx</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">utc</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">utc</span><span class="o">&lt;</span><span class="mi">500</span><span class="p">:</span>
            <span class="n">tidx</span> <span class="o">=</span> <span class="n">utc</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">utc</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">int</span><span class="p">)):</span> <span class="c"># and len(utc[0])==6:</span>
            <span class="n">tidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_idx</span><span class="p">(</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">utc</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">utc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">):</span>
            <span class="n">tidx</span> <span class="o">=</span> <span class="n">utc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Invalid time selection.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="c"># Level</span>
        <span class="c"># if not level:</span>
        <span class="c"># import pdb; pdb.set_trace()</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">check_vertical_coordinate</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">lvidx</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">coords</span> <span class="o">==</span> <span class="s">&#39;index&#39;</span><span class="p">:</span>
            <span class="n">lvidx</span> <span class="o">=</span> <span class="n">level</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span><span class="nb">basestring</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">coords</span> <span class="o">==</span> <span class="s">&#39;surface&#39;</span><span class="p">:</span>
                <span class="n">lvidx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lvidx</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Invalid level selection.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="c"># Lat/lon</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="n">lons</span><span class="p">):</span>
            <span class="c"># What about case where all lats with one lon?</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="k">if</span> <span class="n">lats</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">lonidx</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">latidx</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lons</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">):</span>
                <span class="n">lonidx</span> <span class="o">=</span> <span class="n">lons</span>
                <span class="n">latidx</span> <span class="o">=</span> <span class="n">lats</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">float</span><span class="p">):</span>
                <span class="c"># Interpolate to lat/lon</span>
                <span class="n">lonidx</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">latidx</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="n">lonidx</span> <span class="o">=</span> <span class="n">lons</span>
            <span class="n">latidx</span> <span class="o">=</span> <span class="n">lats</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span><span class="nb">float</span><span class="p">):</span>
            <span class="c"># Interpolate to lat/lon</span>
            <span class="n">lonidx</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">latidx</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Invalid lat/lon selection.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="c"># import pdb; pdb.set_trace()</span>
        <span class="c"># Check if computing required</span>
        <span class="c"># When data is loaded from nc, it is destaggered</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compute</span><span class="p">(</span><span class="n">vrbl</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lvidx</span> <span class="ow">is</span> <span class="s">&#39;isobaric&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_p</span><span class="p">(</span><span class="n">vrbl</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span>
                            <span class="n">latidx</span><span class="p">)[</span><span class="n">N</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lvidx</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="nb">int</span><span class="p">)):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">vrbl</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lvidx</span> <span class="ow">is</span> <span class="s">&#39;isobaric&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_p</span><span class="p">(</span><span class="n">vrbl</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span>
                            <span class="n">latidx</span><span class="p">)[</span><span class="n">N</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">vrbl</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="WRFOut.load"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vrbl</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">):</span>

        <span class="c"># First, check dimension that is staggered (if any)</span>
        <span class="n">destag_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_destagger</span><span class="p">(</span><span class="n">vrbl</span><span class="p">)</span>

        <span class="c"># Next, fetch dimension names</span>
        <span class="n">dim_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dims</span><span class="p">(</span><span class="n">vrbl</span><span class="p">)</span>

        <span class="n">vrbldata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vrbl</span><span class="p">]</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_slice</span><span class="p">(</span><span class="n">vrbl</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">dim_names</span><span class="p">)</span>
        <span class="c"># import pdb; pdb.set_trace()</span>
        <span class="c"># If that dimension has a slice of indices, it doesn&#39;t need staggering.</span>
        <span class="k">if</span> <span class="n">destag_dim</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="n">destag_dim</span><span class="p">],</span><span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">destag_dim</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destagger</span><span class="p">(</span><span class="n">vrbldata</span><span class="p">[</span><span class="n">sl</span><span class="p">],</span><span class="n">destag_dim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="WRFOut.create_slice"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.create_slice">[docs]</a>    <span class="k">def</span> <span class="nf">create_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vrbl</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">dim_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create slices from indices of level, time, lat, lon.</span>
<span class="sd">        Absence of a key means pick all indices.</span>

<span class="sd">        If PS is a list, this is to be converted to slices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># See which dimensions are present in netCDF file variable</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># pdb.set_trace()</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s">&#39;Time&#39;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dim_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tidx</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tidx</span><span class="p">,</span><span class="nb">slice</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tidx</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tidx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">tidx</span><span class="p">,</span><span class="n">tidx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s">&#39;bottom&#39;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dim_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lvidx</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lvidx</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lvidx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lvidx</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lvidx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s">&#39;west&#39;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dim_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lonidx</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lonidx</span><span class="p">,</span><span class="nb">slice</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lonidx</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lonidx</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lonidx</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">lonidx</span><span class="p">,</span><span class="n">lonidx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s">&#39;north&#39;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dim_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">latidx</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">latidx</span><span class="p">,</span><span class="nb">slice</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">latidx</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latidx</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">latidx</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">latidx</span><span class="p">,</span><span class="n">latidx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">sl</span>
</div>
<div class="viewcode-block" id="WRFOut.check_destagger"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.check_destagger">[docs]</a>    <span class="k">def</span> <span class="nf">check_destagger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">var</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Looks up dimensions of netCDF file without loading data.</span>

<span class="sd">        Returns dimension number that requires destaggering</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stag_dim</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">dname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">dimensions</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;stag&#39;</span> <span class="ow">in</span> <span class="n">dname</span><span class="p">:</span>
                <span class="n">stag_dim</span> <span class="o">=</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">stag_dim</span>
</div>
<div class="viewcode-block" id="WRFOut.get_dims"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.get_dims">[docs]</a>    <span class="k">def</span> <span class="nf">get_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">var</span><span class="p">):</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">dimensions</span>
        <span class="k">return</span> <span class="n">dims</span>
</div>
<div class="viewcode-block" id="WRFOut.destagger"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.destagger">[docs]</a>    <span class="k">def</span> <span class="nf">destagger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">ax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Destagger data which needs it doing.</span>

<span class="sd">        data    :   numpy array of data requiring destaggering</span>
<span class="sd">        ax      :   axis requiring destaggering</span>

<span class="sd">        Theta always has unstaggered points in all three spatial dimensions (axes=1,2,3).</span>

<span class="sd">        Data should be 4D but just the slice required to reduce unnecessary computation time.</span>

<span class="sd">        Don&#39;t destagger in x/y for columns</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Check for dimensions of 1.</span>
        <span class="c"># If it exists, don&#39;t destagger it.</span>

        <span class="n">shp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shp</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span><span class="o">==</span><span class="n">ax</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">break</span>

        <span class="c">#pdb.set_trace()</span>

        <span class="k">if</span> <span class="n">ax</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nd</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
            <span class="n">sl0</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c"># Slices to take place on staggered axis</span>
            <span class="n">sl1</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nd</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
                    <span class="n">sl0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>
                    <span class="n">sl1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sl0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">sl1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>

            <span class="n">data_unstag</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">sl0</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">sl1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">data_unstag</span>
</div>
<div class="viewcode-block" id="WRFOut.return_tbl"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.return_tbl">[docs]</a>    <span class="k">def</span> <span class="nf">return_tbl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;shear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_shear</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;thetae&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_thetae</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;cref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_comp_ref</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;wind10&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_wind10</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;wind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_wind</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;CAPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_CAPE</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;Td&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_Td</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_pressure</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;temps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_temps</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;theta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_theta</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;geopot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_geopotential</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_geopotential_height</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;dptp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dptp</span> <span class="c">#density potential temperature pert.</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;dpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dpt</span> <span class="c">#density potential temperature .</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;buoyancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_buoyancy</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;strongestwind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_strongest_wind</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;PMSL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_pmsl</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;RH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_RH</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;dryairmass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dryairmass</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;QTOTAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_qtotal</span>
        <span class="n">tbl</span><span class="p">[</span><span class="s">&#39;olr&#39;</span><span class="p">]</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_olr</span>

        <span class="k">return</span> <span class="n">tbl</span>
</div>
<div class="viewcode-block" id="WRFOut.compute"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute">[docs]</a>    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vrbl</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">,</span><span class="n">lookup</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Look up method needed to return array of data</span>
<span class="sd">        for required variable.</span>

<span class="sd">        Keyword arguments include settings for computation</span>
<span class="sd">        e.g. top and bottom of shear computation</span>

<span class="sd">        lookup      :   enables a check to see if something can be</span>
<span class="sd">                        computed. Returns true or false.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_tbl</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lookup</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">lookup</span> <span class="ow">in</span> <span class="n">tbl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">vrbl</span><span class="p">](</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_RH"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_RH">[docs]</a>    <span class="k">def</span> <span class="nf">compute_RH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;temps&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">Td</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Td&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">RH</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.073</span><span class="o">*</span><span class="p">(</span><span class="n">Td</span><span class="o">-</span><span class="n">T</span><span class="p">))</span>
        <span class="c"># pdb.set_trace()</span>
        <span class="k">return</span> <span class="n">RH</span><span class="o">*</span><span class="mf">100.0</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_dryairmass"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_dryairmass">[docs]</a>    <span class="k">def</span> <span class="nf">compute_dryairmass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">MU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;MU&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">MUB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;MUB&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MU</span> <span class="o">+</span> <span class="n">MUB</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_pmsl"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_pmsl">[docs]</a>    <span class="k">def</span> <span class="nf">compute_pmsl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PSFC&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;T2&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">HGT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HGT&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">T2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">6.5</span><span class="o">*</span><span class="n">HGT</span><span class="p">)</span><span class="o">/</span><span class="mf">1000.0</span>
        <span class="n">pmsl</span> <span class="o">=</span> <span class="n">P</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">9.81</span><span class="o">/</span><span class="p">(</span><span class="mf">287.0</span><span class="o">*</span><span class="n">temp</span><span class="p">)</span><span class="o">*</span><span class="n">HGT</span><span class="p">)</span>

        <span class="c">#sm = kwargs.get(&#39;smooth&#39;,1)</span>
        <span class="c">#data = pmsl[0,::sm,::sm]</span>
        <span class="c">#return data</span>
        <span class="k">return</span> <span class="n">pmsl</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_buoyancy"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_buoyancy">[docs]</a>    <span class="k">def</span> <span class="nf">compute_buoyancy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method from Adams-Selin et al., 2013, WAF</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">thetabar</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">qv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QVAPOR&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">qvbar</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">qv</span><span class="p">)</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="p">((</span><span class="n">theta</span><span class="o">-</span><span class="n">thetabar</span><span class="p">)</span><span class="o">/</span><span class="n">thetabar</span> <span class="o">+</span> <span class="mf">0.61</span><span class="o">*</span><span class="p">(</span><span class="n">qv</span> <span class="o">-</span> <span class="n">qvbar</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">B</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_mixing_ratios"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_mixing_ratios">[docs]</a>    <span class="k">def</span> <span class="nf">compute_mixing_ratios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">qv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QVAPOR&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QCLOUD&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">qr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QRAIN&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">qi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QICE&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;MP scheme has no ice data.&quot;</span><span class="p">)</span>
            <span class="n">qi</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QSNOW&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;MP scheme has no snow data.&quot;</span><span class="p">)</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">qg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QGRAUP&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;MP scheme has no graupel data.&quot;</span><span class="p">)</span>
            <span class="n">qg</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">rh</span> <span class="o">=</span> <span class="n">qc</span> <span class="o">+</span> <span class="n">qr</span> <span class="o">+</span> <span class="n">qi</span> <span class="o">+</span> <span class="n">qs</span> <span class="o">+</span> <span class="n">qg</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">qv</span>

        <span class="k">return</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rv</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_qtotal"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_qtotal">[docs]</a>    <span class="k">def</span> <span class="nf">compute_qtotal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">qtotal</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_mixing_ratios</span><span class="p">(</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qtotal</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_dptp"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_dptp">[docs]</a>    <span class="k">def</span> <span class="nf">compute_dptp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">dpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;dpt&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">dpt_mean</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dpt</span><span class="p">)</span>
        <span class="n">dptp</span> <span class="o">=</span> <span class="n">dpt</span> <span class="o">-</span> <span class="n">dpt_mean</span>
        <span class="k">return</span> <span class="n">dptp</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_dpt"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_dpt">[docs]</a>    <span class="k">def</span> <span class="nf">compute_dpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Potential: if surface level is requested, choose sigma level just</span>
<span class="sd">        about the surface. I don&#39;t think this affects any</span>
<span class="sd">        other dictionaries around...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># if tidx,lvidx,lonidx,latidx[&#39;lv&#39;] == 0:</span>
            <span class="c"># tidx,lvidx,lonidx,latidx[&#39;lv&#39;] = 0</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">rh</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_mixing_ratios</span><span class="p">(</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

        <span class="n">dpt</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.61</span><span class="o">*</span><span class="n">rv</span> <span class="o">-</span> <span class="n">rh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dpt</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_geopotential_height"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_geopotential_height">[docs]</a>    <span class="k">def</span> <span class="nf">compute_geopotential_height</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">geopotential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PH&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PHB&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">geopotential</span><span class="o">/</span><span class="mf">9.81</span>
        <span class="k">return</span> <span class="n">Z</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_geopotential"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_geopotential">[docs]</a>    <span class="k">def</span> <span class="nf">compute_geopotential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">geopotential</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PH&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PHB&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">geopotential</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_wind10"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_wind10">[docs]</a>    <span class="k">def</span> <span class="nf">compute_wind10</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;U10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;V10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_pressure"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_pressure">[docs]</a>    <span class="k">def</span> <span class="nf">compute_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">PP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">PB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PB&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">pressure</span> <span class="o">=</span> <span class="n">PP</span> <span class="o">+</span> <span class="n">PB</span>
        <span class="k">return</span> <span class="n">pressure</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_temps"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_temps">[docs]</a>    <span class="k">def</span> <span class="nf">compute_temps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="s">&#39;K&#39;</span><span class="p">):</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">temps</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="p">((</span><span class="n">P</span><span class="o">/</span><span class="mf">100000.0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">287.04</span><span class="o">/</span><span class="mf">1004.0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">==</span><span class="s">&#39;K&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">temps</span>
        <span class="k">elif</span> <span class="n">other</span><span class="o">==</span><span class="s">&#39;C&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">temps</span><span class="o">-</span><span class="mf">273.15</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_theta"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_theta">[docs]</a>    <span class="k">def</span> <span class="nf">compute_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">Tbase</span> <span class="o">=</span> <span class="mf">300.0</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">Tbase</span> <span class="o">+</span> <span class="n">theta</span>
        <span class="k">return</span> <span class="n">theta</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_wind"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_wind">[docs]</a>    <span class="k">def</span> <span class="nf">compute_wind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="c"># pdb.set_trace()</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;U&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;V&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_shear"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_shear">[docs]</a>    <span class="k">def</span> <span class="nf">compute_shear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        top and bottom in km.</span>
<span class="sd">        kwargs[&#39;top&#39;]</span>
<span class="sd">        kwargs[&#39;bottom&#39;]</span>

<span class="sd">        Could make this faster with numpy.digitize()?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">topm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;top&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>
        <span class="n">botm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bottom&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;U&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;V&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

        <span class="n">topidx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">450</span><span class="p">,</span><span class="mi">450</span><span class="p">))</span>
        <span class="n">botidx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">450</span><span class="p">,</span><span class="mi">450</span><span class="p">))</span>
        <span class="n">ushear</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">450</span><span class="p">,</span><span class="mi">450</span><span class="p">))</span>
        <span class="n">vshear</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">450</span><span class="p">,</span><span class="mi">450</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span><span class="p">):</span>
                <span class="n">topidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                                <span class="n">topm</span><span class="p">,</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_dim</span><span class="p">)))</span>
                <span class="n">botidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                                <span class="n">botm</span><span class="p">,</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_dim</span><span class="p">)))</span>
                <span class="n">ushear</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">topidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">botidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">vshear</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">topidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">botidx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

        <span class="c"># Find indices of bottom and top levels</span>
        <span class="c"># topidx = N.where(abs(Z-topm) == abs(Z-topm).min(axis=1))</span>
        <span class="c"># botidx = N.where(abs(Z-botm) == abs(Z-botm).min(axis=1))</span>

        <span class="c"># ushear = u[0,:,topidx] - u[0,:,botidx]</span>
        <span class="c"># vshear = v[0,topidx,:,:] - v[0,botidx,:,:]</span>

        <span class="n">shear</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ushear</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vshear</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c"># pdb.set_trace()</span>
        <span class="k">return</span> <span class="n">shear</span>
</div>
    <span class="k">def</span> <span class="nf">compute_thetae</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span> <span class="c"># Computed</span>
        <span class="n">Drybulb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;temp&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Q&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

        <span class="n">thetae</span> <span class="o">=</span> <span class="p">(</span><span class="n">Drybulb</span> <span class="o">+</span> <span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">cc</span><span class="o">.</span><span class="n">Lv</span><span class="o">/</span><span class="n">cc</span><span class="o">.</span><span class="n">cp</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">P0</span><span class="o">/</span><span class="n">P</span><span class="p">)</span> <span class="o">**</span> <span class="n">cc</span><span class="o">.</span><span class="n">kappa</span>
        <span class="k">return</span> <span class="n">thetae</span>

<div class="viewcode-block" id="WRFOut.compute_olr"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_olr">[docs]</a>    <span class="k">def</span> <span class="nf">compute_olr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">OLR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;OLR&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">sbc</span> <span class="o">=</span> <span class="mf">0.000000056704</span>
        <span class="n">ir</span> <span class="o">=</span> <span class="p">((</span><span class="n">OLR</span><span class="o">/</span><span class="n">sbc</span><span class="p">)</span><span class="o">**</span><span class="mf">0.25</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span>
        <span class="k">return</span> <span class="n">ir</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_comp_ref"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_comp_ref">[docs]</a>    <span class="k">def</span> <span class="nf">compute_comp_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Amend this so variables obtain at start fetch only correct date, lats, lons</span>
<span class="sd">        All levels need to be fetched as this is composite reflectivity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;T2&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="c"># QR = self.nc.variables[&#39;QRAIN&#39;][PS[&#39;t&#39;],:,PS[&#39;la&#39;],PS[&#39;lo&#39;]]</span>
        <span class="n">QR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QRAIN&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span> <span class="c"># This should get all levels</span>
        <span class="n">PSFC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PSFC&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">QS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QSNOW&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">QS</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">QR</span><span class="p">))</span>
        <span class="n">rhor</span> <span class="o">=</span> <span class="mf">1000.0</span>
        <span class="n">rhos</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="n">rhog</span> <span class="o">=</span> <span class="mf">400.0</span>
        <span class="n">rhoi</span> <span class="o">=</span> <span class="mf">917.0</span>

        <span class="n">no_rain</span> <span class="o">=</span> <span class="mf">8.0E6</span>
        <span class="c"># How do I access this time?</span>
        <span class="n">no_snow</span> <span class="o">=</span> <span class="mf">2.0E6</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="o">*</span><span class="p">(</span><span class="n">T2</span><span class="o">-</span><span class="mf">273.15</span><span class="p">))</span>
        <span class="n">no_grau</span> <span class="o">=</span> <span class="mf">4.0E6</span>

        <span class="n">density</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">PSFC</span><span class="p">,(</span><span class="mf">287.0</span> <span class="o">*</span> <span class="n">T2</span><span class="p">))</span>
        <span class="n">Qra_all</span> <span class="o">=</span> <span class="n">QR</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">Qsn_all</span> <span class="o">=</span> <span class="n">QS</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Qra_all</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">curcol_r</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curcol_s</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Qra_all</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:])):</span>
                    <span class="n">maxrval</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Qra_all</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">maxsval</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Qsn_all</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">curcol_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxrval</span><span class="p">)</span>
                    <span class="n">curcol_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxsval</span><span class="p">)</span>
            <span class="n">N_curcol_r</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">curcol_r</span><span class="p">)</span>
            <span class="n">N_curcol_s</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">curcol_s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Qra</span> <span class="o">=</span> <span class="n">N_curcol_r</span>
                <span class="n">Qsn</span> <span class="o">=</span> <span class="n">N_curcol_s</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Qra</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">row_stack</span><span class="p">((</span><span class="n">Qra</span><span class="p">,</span> <span class="n">N_curcol_r</span><span class="p">))</span>
                <span class="n">Qsn</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">row_stack</span><span class="p">((</span><span class="n">Qsn</span><span class="p">,</span> <span class="n">N_curcol_s</span><span class="p">))</span>

        <span class="c"># Calculate slope factor lambda</span>
        <span class="n">lambr</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="mf">3.14159</span> <span class="o">*</span> <span class="n">no_rain</span> <span class="o">*</span> <span class="n">rhor</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">density</span><span class="p">,</span> <span class="n">Qra</span><span class="p">)</span><span class="o">+</span><span class="n">N</span><span class="o">.</span><span class="n">nextafter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span> <span class="o">**</span> <span class="mf">0.25</span>
        <span class="n">lambs</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0536</span> <span class="o">*</span> <span class="p">(</span><span class="n">T2</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">))</span>

        <span class="c"># Calculate equivalent reflectivity factor</span>
        <span class="n">Zer</span> <span class="o">=</span> <span class="p">(</span><span class="mf">720.0</span> <span class="o">*</span> <span class="n">no_rain</span> <span class="o">*</span> <span class="p">(</span><span class="n">lambr</span> <span class="o">**</span> <span class="o">-</span><span class="mf">7.0</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1E18</span>
        <span class="n">Zes</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.224</span> <span class="o">*</span> <span class="mf">720.0</span> <span class="o">*</span> <span class="n">no_snow</span> <span class="o">*</span> <span class="p">(</span><span class="n">lambr</span> <span class="o">**</span> <span class="o">-</span><span class="mf">7.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhos</span><span class="o">/</span><span class="n">rhoi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1E18</span>
        <span class="n">Zes_int</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="n">lambs</span> <span class="o">*</span> <span class="n">Qsn</span> <span class="o">*</span> <span class="n">density</span><span class="p">),</span> <span class="n">no_snow</span><span class="p">)</span>
        <span class="n">Zes</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.224</span> <span class="o">*</span> <span class="mi">720</span> <span class="o">*</span> <span class="mf">1E18</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.14159</span> <span class="o">*</span> <span class="n">rhor</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Zes_int</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">Ze</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Zer</span><span class="p">,</span> <span class="n">Zes</span><span class="p">)</span>
        <span class="n">dBZ</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Ze</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dBZ</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_simref_atlevel"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_simref_atlevel">[docs]</a>    <span class="k">def</span> <span class="nf">compute_simref_atlevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">pass</span>
        <span class="k">return</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_DCP"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_DCP">[docs]</a>    <span class="k">def</span> <span class="nf">compute_DCP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Derecho Composite Parameter (Evans and Doswell, 2001, WAF)</span>
<span class="sd">        And info from SPC Mesoanalyses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">DCAPE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DCAPE&#39;</span><span class="p">)</span>
        <span class="n">MUCAPE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;MUCAPE&#39;</span><span class="p">)</span>
        <span class="n">shear_0_6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;shear&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">meanwind_0_6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;meanwind&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">DCP</span> <span class="o">=</span> <span class="p">(</span><span class="n">DCAPE</span><span class="o">/</span><span class="mf">980.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">MUCAPE</span><span class="o">/</span><span class="mf">2000.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">shear_0_6</span><span class="o">/</span><span class="mf">20.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">meanwind_0_6</span><span class="o">/</span><span class="mf">16.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DCP</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_DCAPE"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_DCAPE">[docs]</a>    <span class="k">def</span> <span class="nf">compute_DCAPE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_thetae"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_thetae">[docs]</a>    <span class="k">def</span> <span class="nf">compute_thetae</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;temps&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">units</span><span class="o">=</span><span class="s">&#39;K&#39;</span><span class="p">)</span>
        <span class="n">Td</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Td&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">p2</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">drylift</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">Td</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">wetlift</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="mf">100.0</span><span class="p">)</span>
        <span class="n">thetae</span> <span class="o">=</span> <span class="n">thermo</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thetae</span>

</div>
<div class="viewcode-block" id="WRFOut.compute_Td"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_Td">[docs]</a>    <span class="k">def</span> <span class="nf">compute_Td</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Using HootPy equation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;QVAPOR&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Q</span><span class="p">))</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">P</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">0.622</span><span class="p">,</span><span class="n">w</span><span class="p">))</span><span class="o">/</span><span class="mf">100.0</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">243.5</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mf">6.112</span><span class="p">)))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mf">17.67</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mf">6.112</span><span class="p">)))</span>
        <span class="n">Td</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="c"># pdb.set_trace()</span>
        <span class="k">return</span> <span class="n">Td</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_CAPE"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_CAPE">[docs]</a>    <span class="k">def</span> <span class="nf">compute_CAPE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        INCOMPLETE!</span>

<span class="sd">        CAPE method based on GEMPAK&#39;s pdsuml.f function</span>

<span class="sd">        Inputs:</span>

<span class="sd">        tidx,lvidx,lonidx,latidx  :   dictionary of level/time/lat/lon</span>



<span class="sd">        Outputs:</span>
<span class="sd">        CAPE    :   convective available potential energy</span>
<span class="sd">        CIN     :   convective inhibition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Make sure all levels are obtained</span>
        <span class="c">#tidx,lvidx,lonidx,latidx[&#39;lv&#39;] = slice(None,None)</span>

        <span class="n">totalCAPE</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">totalCIN</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lvidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lvidx</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c"># This should loop over the levels?</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            z1      :   bottom of layer (index)</span>
<span class="sd">            z2      :   top of layer (index)</span>
<span class="sd">            th1     :   theta (environ) at z1</span>
<span class="sd">            th2     :   theta (environ) at z2</span>
<span class="sd">            thp1    :   theta (parcel) at z1</span>
<span class="sd">            thp2    :   theta (parcel) at z2</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">z1</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
            <span class="n">z2</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">lvidx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

            <span class="n">th1</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
            <span class="n">th2</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">lvidx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

            <span class="n">thp1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">thp2</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">capeT</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">cinT</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">dt2</span> <span class="o">=</span> <span class="n">thp2</span> <span class="o">-</span> <span class="n">th2</span>
            <span class="n">dt1</span> <span class="o">=</span> <span class="n">thp1</span> <span class="o">-</span> <span class="n">th1</span>

            <span class="n">dz</span> <span class="o">=</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">z1</span>

            <span class="n">dt1_pos_ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">dt1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dt1_neg_ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">dt1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">dt2_pos_ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">dt2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dt2_neg_ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">dt2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">dt1_pos</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">dt1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],[</span><span class="n">dt1</span><span class="p">])</span>
            <span class="n">dt1_neg</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">dt1</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">],[</span><span class="n">dt1</span><span class="p">])</span>
            <span class="n">dt2_pos</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">dt2</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],[</span><span class="n">dt1</span><span class="p">])</span>
            <span class="n">dt2_neg</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">dt2</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">],[</span><span class="n">dt1</span><span class="p">])</span>

            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">dt1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dt2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">capeT</span> <span class="o">=</span> <span class="p">((</span><span class="n">dt2</span> <span class="o">+</span> <span class="n">dt1</span><span class="p">)</span><span class="o">*</span><span class="n">dz</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">th2</span><span class="o">+</span><span class="n">th1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dt1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">dt1</span><span class="o">/</span><span class="p">(</span><span class="n">dt1</span><span class="o">-</span><span class="n">dt2</span><span class="p">)</span>
                <span class="n">zeq</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="p">(</span><span class="n">dz</span><span class="o">*</span><span class="n">ratio</span><span class="p">)</span>
                <span class="n">teq</span> <span class="o">=</span> <span class="n">th1</span> <span class="o">+</span> <span class="p">((</span><span class="n">th2</span><span class="o">-</span><span class="n">th1</span><span class="p">)</span><span class="o">*</span><span class="n">ratio</span><span class="p">)</span>
                <span class="n">capeT</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt1</span><span class="o">*</span><span class="p">(</span><span class="n">zeq</span><span class="o">-</span><span class="n">z1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">th1</span><span class="o">+</span><span class="n">teq</span><span class="p">)</span>
                <span class="n">cinT</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt2</span><span class="o">*</span><span class="p">(</span><span class="n">z2</span><span class="o">-</span><span class="n">zeq</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">th2</span><span class="o">+</span><span class="n">teq</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dt2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">dt2</span><span class="o">/</span><span class="p">(</span><span class="n">dt2</span><span class="o">-</span><span class="n">dt1</span><span class="p">)</span>
                <span class="n">zfc</span> <span class="o">=</span> <span class="n">z2</span><span class="o">-</span><span class="p">(</span><span class="n">dz</span><span class="o">*</span><span class="n">ratio</span><span class="p">)</span>
                <span class="n">tfc</span> <span class="o">=</span> <span class="n">th2</span><span class="o">-</span><span class="p">((</span><span class="n">th2</span><span class="o">-</span><span class="n">th1</span><span class="p">)</span><span class="o">*</span><span class="n">ratio</span><span class="p">)</span>
                <span class="n">capeT</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt2</span><span class="o">*</span><span class="p">(</span><span class="n">z2</span><span class="o">-</span><span class="n">zfc</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tfc</span><span class="o">+</span><span class="n">th2</span><span class="p">))</span>
                <span class="n">cinT</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt1</span><span class="o">*</span><span class="p">(</span><span class="n">zfc</span><span class="o">-</span><span class="n">z1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tfc</span><span class="o">+</span><span class="n">th1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cinT</span> <span class="o">=</span> <span class="p">((</span><span class="n">dt2</span><span class="o">+</span><span class="n">dt1</span><span class="p">)</span><span class="o">*</span><span class="n">dz</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">th2</span><span class="o">+</span><span class="n">th1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">capeT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">CAPE</span> <span class="o">=</span> <span class="n">capeT</span> <span class="o">*</span> <span class="n">cc</span><span class="o">.</span><span class="n">g</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">CAPE</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">cinT</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">CIN</span> <span class="o">=</span> <span class="n">cinT</span> <span class="o">*</span> <span class="n">cc</span><span class="o">.</span><span class="n">g</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">CIN</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">totalCAPE</span> <span class="o">+=</span> <span class="n">CAPE</span>
                <span class="n">totalCIN</span> <span class="o">+=</span> <span class="n">CIN</span>

        <span class="k">return</span> <span class="n">totalCAPE</span><span class="p">,</span><span class="n">totalCIN</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_ave"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_ave">[docs]</a>    <span class="k">def</span> <span class="nf">compute_ave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">va</span><span class="p">,</span><span class="n">z1</span><span class="p">,</span><span class="n">z2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute average values for variable in layer</span>

<span class="sd">        Inputs:</span>
<span class="sd">        va      :   variable</span>
<span class="sd">        z1      :   height at bottom</span>
<span class="sd">        z2      :   height at top</span>

<span class="sd">        Output:</span>
<span class="sd">        data    :   the averaged variable</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Get coordinate system</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_vcs</span><span class="p">(</span><span class="n">z1</span><span class="p">,</span><span class="n">z2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_strongest_wind"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_strongest_wind">[docs]</a>    <span class="k">def</span> <span class="nf">compute_strongest_wind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wind10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)</span>
        <span class="n">wind_max</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">wind</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c"># wind_max_smooth = self.test_smooth(wind_max)</span>
        <span class="c"># return wind_max_smooth</span>
        <span class="k">return</span> <span class="n">wind_max</span>
</div>
<div class="viewcode-block" id="WRFOut.check_vcs"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.check_vcs">[docs]</a>    <span class="k">def</span> <span class="nf">check_vcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">z1</span><span class="p">,</span><span class="n">z2</span><span class="p">,</span><span class="n">exception</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the vertical coordinate systems</span>

<span class="sd">        If identical, return the system</span>
<span class="sd">        If not, raise an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">vc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">level_type</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">level_type</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vc1</span> <span class="o">!=</span> <span class="n">vc2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Vertical coordinate systems not identical.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vc1</span>
</div>
<div class="viewcode-block" id="WRFOut.get_XY"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.get_XY">[docs]</a>    <span class="k">def</span> <span class="nf">get_XY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return grid indices for lat/lon pair.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="WRFOut.get_limited_domain"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.get_limited_domain">[docs]</a>    <span class="k">def</span> <span class="nf">get_limited_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">da</span><span class="p">,</span><span class="n">skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">return_array</span><span class="o">=</span><span class="s">&#39;idx&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return smaller array of lats, lons depending on</span>
<span class="sd">        input dictionary of N, E, S, W limits.</span>

<span class="sd">        skip            :   for creating thinned domains</span>
<span class="sd">        return_type     :   if idx, return array of idx</span>
<span class="sd">                            if slice, return slice only</span>
<span class="sd">                            if latlon, return lat/lon values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">da</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span> 
            <span class="n">N_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lat_idx</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s">&#39;Nlim&#39;</span><span class="p">])</span>
            <span class="n">E_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lon_idx</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s">&#39;Elim&#39;</span><span class="p">])</span>
            <span class="n">S_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lat_idx</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s">&#39;Slim&#39;</span><span class="p">])</span>
            <span class="n">W_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lon_idx</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s">&#39;Wlim&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">N_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats1D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">E_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons1D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">S_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">W_idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">return_array</span><span class="o">==</span><span class="s">&#39;latlon&#39;</span> <span class="ow">or</span> <span class="n">return_array</span><span class="o">==</span><span class="s">&#39;slice&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">da</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
                <span class="n">lat_sl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">S_idx</span><span class="p">,</span><span class="n">N_idx</span><span class="p">,</span><span class="n">skip</span><span class="p">)</span>
                <span class="n">lon_sl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">W_idx</span><span class="p">,</span><span class="n">E_idx</span><span class="p">,</span><span class="n">skip</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lat_sl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="n">skip</span><span class="p">)</span>
                <span class="n">lon_sl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="n">skip</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">return_array</span> <span class="o">==</span> <span class="s">&#39;latlon&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats1D</span><span class="p">[</span><span class="n">lat_sl</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons1D</span><span class="p">[</span><span class="n">lon_sl</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">return</span> <span class="n">lat_sl</span><span class="p">,</span> <span class="n">lon_sl</span>
        <span class="k">elif</span> <span class="n">return_array</span><span class="o">==</span><span class="s">&#39;idx&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S_idx</span><span class="p">,</span><span class="n">N_idx</span><span class="p">,</span><span class="n">skip</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">W_idx</span><span class="p">,</span><span class="n">E_idx</span><span class="p">,</span><span class="n">skip</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Invalid selection for return_array.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
</div>
<div class="viewcode-block" id="WRFOut.get_lat_idx"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.get_lat_idx">[docs]</a>    <span class="k">def</span> <span class="nf">get_lat_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lat</span><span class="p">):</span>
        <span class="n">lat_idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="o">-</span><span class="n">lat</span><span class="p">)</span> <span class="o">==</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="o">-</span><span class="n">lat</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lat_idx</span>
</div>
<div class="viewcode-block" id="WRFOut.get_lon_idx"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.get_lon_idx">[docs]</a>    <span class="k">def</span> <span class="nf">get_lon_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lon</span><span class="p">):</span>
        <span class="n">lon_idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="o">-</span><span class="n">lon</span><span class="p">)</span> <span class="o">==</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="o">-</span><span class="n">lon</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lon_idx</span>
</div>
<div class="viewcode-block" id="WRFOut.get_p"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.get_p">[docs]</a>    <span class="k">def</span> <span class="nf">get_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vrbl</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an pressure level isosurface of given variable.</span>
<span class="sd">        Interpolation is linear so watch out.</span>

<span class="sd">        Dimensions returns as (height,lat,lon)</span>
<span class="sd">        Or is it (height,lon, lat!?)</span>

<span class="sd">        TODO: Need to include limited domain functionality</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">level</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;hPa&#39;</span><span class="p">):</span>
            <span class="n">hPa</span> <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;h&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">nlv</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">)):</span>
            <span class="n">hPa</span> <span class="o">=</span> <span class="n">level</span><span class="o">*</span><span class="mf">100.0</span>
            <span class="n">nlv</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
            <span class="n">hPa</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">*</span><span class="mf">100.0</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">level</span><span class="p">]</span>
            <span class="n">nlv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hPa</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Use XXXhPa, an integer, or list of integers for level.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="c"># If this breaks, user is requesting non-4D data</span>
        <span class="c"># Duck-typing for the win</span>

        <span class="n">datain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vrbl</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">tidx</span><span class="p">,</span><span class="n">lons</span><span class="o">=</span><span class="n">lonidx</span><span class="p">,</span><span class="n">lats</span><span class="o">=</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pressure&#39;</span><span class="p">,</span><span class="n">utc</span><span class="o">=</span><span class="n">tidx</span><span class="p">,</span><span class="n">lons</span><span class="o">=</span><span class="n">lonidx</span><span class="p">,</span><span class="n">lats</span><span class="o">=</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="c"># import pdb; pdb.set_trace()</span>
        <span class="n">dataout</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nlv</span><span class="p">,</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="c"># pdb.set_trace()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">N</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">dataout</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]):</span>
            <span class="n">dataout</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">hPa</span><span class="p">,</span><span class="n">P</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">datain</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c"># dataout = scipy.interpolate.griddata(P.flatten(),datain.flatten(),hPa)</span>
        <span class="k">if</span> <span class="n">nlv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># Return 2D if only one level requested</span>
            <span class="k">return</span> <span class="n">dataout</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dataout</span>
</div>
<div class="viewcode-block" id="WRFOut.interp_to_p_fortran"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.interp_to_p_fortran">[docs]</a>    <span class="k">def</span> <span class="nf">interp_to_p_fortran</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">,</span><span class="n">nc_path</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">lv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Uses p_interp fortran code to put data onto a pressure</span>
<span class="sd">        level specified.</span>

<span class="sd">        Input:</span>
<span class="sd">        config  :   contains directory of p_interp files</span>
<span class="sd">        nc_path :   path to original netCDF file data</span>
<span class="sd">        var     :   variable(s) to compute</span>
<span class="sd">        lv      :   pressure level(s) to compute</span>

<span class="sd">        Returns:</span>
<span class="sd">        fpath   :   path to new netCDF file with p co-ords</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Fetch paths</span>
        <span class="n">p_interp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">p_interp_root</span><span class="p">,</span><span class="s">&#39;p_interp&#39;</span><span class="p">)</span>
        <span class="n">namelist_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">config</span><span class="o">.</span><span class="n">p_interp_root</span><span class="p">,</span><span class="s">&#39;namelist.pinterp&#39;</span><span class="p">)</span>
        <span class="n">nc_root</span><span class="p">,</span> <span class="n">nc_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">nc_path</span><span class="p">)</span><span class="c"># Root directory of wrfout file</span>
        <span class="n">output_root</span> <span class="o">=</span> <span class="n">nc_root</span> <span class="c"># Directory to dump output file (same)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Can we add a suffix to the new netCDF file?</span>
<span class="sd">        Check to see if file already exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Copy old p_interp for backup</span>
        <span class="n">command1</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&#39;cp&#39;</span><span class="p">,</span><span class="n">p_interp_path</span><span class="p">,</span><span class="n">p_interp_path</span><span class="o">+</span><span class="s">&#39;.bkup&#39;</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command1</span><span class="p">)</span>

        <span class="c"># Edit p_interp&#39;s namelist settings</span>
        <span class="n">edit_namelist</span><span class="p">(</span><span class="n">path_to_interp</span><span class="p">,</span><span class="s">&#39;path_to_input&#39;</span><span class="p">,</span><span class="n">nc_root</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">edit_namelist</span><span class="p">(</span><span class="n">path_to_interp</span><span class="p">,</span><span class="s">&#39;input_name&#39;</span><span class="p">,</span><span class="n">nc_fname</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">edit_namelist</span><span class="p">(</span><span class="n">path_to_interp</span><span class="p">,</span><span class="s">&#39;path_to_output&#39;</span><span class="p">,</span><span class="n">output_root</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">edit_namelist</span><span class="p">(</span><span class="n">path_to_interp</span><span class="p">,</span><span class="s">&#39;process&#39;</span><span class="p">,</span><span class="s">&#39;list&#39;</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">edit_namelist</span><span class="p">(</span><span class="n">path_to_interp</span><span class="p">,</span><span class="s">&#39;fields&#39;</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">edit_namelist</span><span class="p">(</span><span class="n">path_to_interp</span><span class="p">,</span><span class="s">&#39;met_em_output&#39;</span><span class="p">,</span><span class="s">&#39;.FALSE.&#39;</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">edit_namelist</span><span class="p">(</span><span class="n">path_to_interp</span><span class="p">,</span><span class="s">&#39;fields&#39;</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

        <span class="n">command2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;./&#39;</span><span class="p">,</span><span class="n">p_interp_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command2</span><span class="p">)</span> <span class="c"># This should execute the script</span>

        <span class="k">return</span> <span class="n">fpath</span>

</div>
<div class="viewcode-block" id="WRFOut.edit_namelist"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.edit_namelist">[docs]</a>    <span class="k">def</span> <span class="nf">edit_namelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fpath</span><span class="p">,</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">,</span><span class="n">incolumn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="mi">23</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;col=23 is default for wps namelists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">flines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c"># Prefix for soil intermediate data filename</span>
                <span class="k">if</span> <span class="n">incolumn</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">flines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">flines</span><span class="p">[</span><span class="n">idx</span><span class="p">][:</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">new</span> <span class="o">+</span> <span class="s">&quot; </span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">old</span> <span class="o">+</span> <span class="s">&#39; = &#39;</span> <span class="o">+</span> <span class="n">new</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="n">nameout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">nameout</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">flines</span><span class="p">)</span>
                <span class="n">nameout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>
</div>
<div class="viewcode-block" id="WRFOut.get_limits"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.get_limits">[docs]</a>    <span class="k">def</span> <span class="nf">get_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Nlim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Elim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Slim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Wlim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Nlim</span><span class="p">,</span> <span class="n">Elim</span><span class="p">,</span> <span class="n">Slim</span><span class="p">,</span> <span class="n">Wlim</span>
</div>
<div class="viewcode-block" id="WRFOut.cold_pool_strength"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.cold_pool_strength">[docs]</a>    <span class="k">def</span> <span class="nf">cold_pool_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">swath_width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dz</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns array the same shape as WRF domain.</span>

<span class="sd">        X   :   cross-section object with given path</span>
<span class="sd">                This path goes front-to-back through a bow</span>
<span class="sd">        km  :   width in the line-normal direction</span>
<span class="sd">        env :   (x,y) for location to sample environmental dpt</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Set up slices</span>
        <span class="n">time_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_idx</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="c"># lv_idx = 0</span>

        <span class="c"># slices = {&#39;t&#39;: time_idx, &#39;lv&#39;: lv_idx, &#39;la&#39;: lat_sl, &#39;lo&#39;: lon_sl}</span>
        <span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;t&#39;</span><span class="p">:</span><span class="n">time_idx</span><span class="p">}</span>

        <span class="c"># Get wind data</span>
        <span class="n">wind10</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wind10&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;T2&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

        <span class="c"># This is the 2D plane for calculation data</span>
        <span class="n">coldpooldata</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wind10</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c"># Compute required C2 fields to save time</span>
        <span class="n">dpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;dpt&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">HGT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HGT&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">lvidx</span><span class="p">,</span><span class="n">lonidx</span><span class="p">,</span><span class="n">latidx</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="n">heights</span> <span class="o">=</span> <span class="n">Z</span><span class="o">-</span><span class="n">HGT</span>
        <span class="c"># pdb.set_trace()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">collections</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
            <span class="n">xx_env</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">yy_env</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">env</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">dpt_env</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dpt</span><span class="p">[:,</span><span class="n">yy_env</span><span class="p">,</span><span class="n">xx_env</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># All cross-sections (parallel)</span>

        <span class="c"># xxx = [X.xx,]</span>
        <span class="c"># yyy = [X.yy,]</span>
        <span class="n">X</span><span class="o">.</span><span class="n">translate_xs</span><span class="p">(</span><span class="o">-</span><span class="n">swath_width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">swath_width</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Cross section #{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="c"># for xx, yy in zip(xxx, yyy):</span>
            <span class="n">X</span><span class="o">.</span><span class="n">translate_xs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">xx</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">yy</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">wind_slice</span> <span class="o">=</span> <span class="n">wind10</span><span class="p">[</span><span class="n">yy</span><span class="p">,</span><span class="n">xx</span><span class="p">]</span>
            <span class="n">T2_slice</span> <span class="o">=</span> <span class="n">T2</span><span class="p">[</span><span class="n">yy</span><span class="p">,</span><span class="n">xx</span><span class="p">]</span>
            <span class="n">slice_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_gust_front</span><span class="p">(</span><span class="n">wind_slice</span><span class="p">,</span><span class="n">T2_slice</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>

            <span class="n">gfx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">slice_loc</span><span class="p">]</span>
            <span class="n">gfy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">slice_loc</span><span class="p">]</span>
            <span class="n">gf_pts</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xx</span><span class="o">==</span><span class="n">gfx</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yy</span><span class="o">==</span><span class="n">gfy</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">gf_pt</span> <span class="o">=</span> <span class="n">gf_pts</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gf_pts</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)]</span>
            <span class="n">xx_cp</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[:</span><span class="n">gf_pt</span><span class="p">]</span>
            <span class="n">yy_cp</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[:</span><span class="n">gf_pt</span><span class="p">]</span>
            <span class="c"># pdb.set_trace()</span>

            <span class="c"># Compute enviromental dpt at each height</span>
            <span class="c"># Average all levels from the location of gust front</span>
            <span class="c"># forwards to the end of the cross-section.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="p">:</span>
                <span class="n">xx_env</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="n">gf_pt</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">yy_env</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="n">gf_pt</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">dpt_env</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dpt</span><span class="p">[:,</span><span class="n">yy_env</span><span class="p">,</span><span class="n">xx_env</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c"># pdb.set_trace()</span>

            <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xx_cp</span><span class="p">,</span><span class="n">yy_cp</span><span class="p">):</span>
            <span class="c">#for x,y in zip(xx,yy):</span>
                <span class="k">if</span> <span class="n">dz</span><span class="p">:</span>
                    <span class="n">coldpooldata</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_cpdz</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dpt</span><span class="p">[:,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">],</span><span class="n">heights</span><span class="p">[:,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">],</span><span class="n">dpt_env</span><span class="p">)</span>
                    <span class="c"># pdb.set_trace()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coldpooldata</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_C2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dpt</span><span class="p">[:,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">],</span><span class="n">heights</span><span class="p">[:,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">],</span><span class="n">dpt_env</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">coldpooldata</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_cpdz"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_cpdz">[docs]</a>    <span class="k">def</span> <span class="nf">compute_cpdz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dpt</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">dpt_env</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cold pool depth</span>

<span class="sd">        x       :   x location in domain</span>
<span class="sd">        y       :   y location in domain</span>
<span class="sd">        dpt     :   density potential temperature slice</span>
<span class="sd">        heights :   height AGL slice</span>
<span class="sd">        dpt_env :   environmental dpt, column</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dz</span><span class="p">,</span> <span class="n">zidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cold_pool_depth</span><span class="p">(</span><span class="n">dpt</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">dpt_env</span><span class="p">)</span>
        <span class="c"># import pdb; pdb.set_trace()</span>
        <span class="k">return</span> <span class="n">dz</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_C2"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_C2">[docs]</a>    <span class="k">def</span> <span class="nf">compute_C2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dpt</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">dpt_env</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        C^2 as found in James et al. 2006 MWR</span>

<span class="sd">        x       :   x location in domain</span>
<span class="sd">        y       :   y location in domain</span>
<span class="sd">        dpt     :   density potential temperature slice</span>
<span class="sd">        heights :   height AGL slice</span>
<span class="sd">        dpt_env :   environmental dpt, column</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dz</span><span class="p">,</span> <span class="n">zidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cold_pool_depth</span><span class="p">(</span><span class="n">dpt</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">dpt_env</span><span class="p">)</span>
        <span class="n">C2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">mc</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="p">((</span><span class="n">dpt</span><span class="p">[</span><span class="n">zidx</span><span class="p">]</span><span class="o">-</span><span class="n">dpt_env</span><span class="p">[</span><span class="n">zidx</span><span class="p">])</span><span class="o">/</span><span class="n">dpt_env</span><span class="p">[</span><span class="n">zidx</span><span class="p">])</span><span class="o">*</span><span class="n">dz</span>
        <span class="c"># print(&quot;dpt = {0} ... dpt_env = {1} ... C2 = {2}&quot;.format(dpt[0],dpt_env[0],C2))</span>
        <span class="k">return</span> <span class="n">C2</span>
</div>
<div class="viewcode-block" id="WRFOut.cold_pool_depth"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.cold_pool_depth">[docs]</a>    <span class="k">def</span> <span class="nf">cold_pool_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dpt</span><span class="p">,</span><span class="n">heights</span><span class="p">,</span><span class="n">dpt_env</span><span class="p">):</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># thresh = -2.0</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">z</span><span class="p">,</span> <span class="n">de</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dpt</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">heights</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">dpt_env</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">dptp</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">de</span>
            <span class="k">if</span> <span class="n">dptp</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">z</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dz</span><span class="p">,</span><span class="nb">float</span><span class="p">):</span>
            <span class="n">zidx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">heights</span><span class="o">==</span><span class="n">dz</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zidx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># import pdb; pdb.set_trace()</span>
        <span class="k">return</span> <span class="n">dz</span><span class="p">,</span> <span class="n">zidx</span>
</div>
<div class="viewcode-block" id="WRFOut.find_gust_front"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.find_gust_front">[docs]</a>    <span class="k">def</span> <span class="nf">find_gust_front</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wind_slice</span><span class="p">,</span><span class="n">T2_slice</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find location of maximum shear in the horizontal wind along a</span>
<span class="sd">        1D slice.</span>

<span class="sd">        wind_slice      :   1D numpy array</span>
<span class="sd">        T2_slice        :   temp 2m slice</span>
<span class="sd">        angle           :   angle of slice cross-section</span>
<span class="sd">        method          :   way to locate gust front</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">shp</span> <span class="o">=</span> <span class="n">wind_slice</span><span class="o">.</span><span class="n">shape</span>

        <span class="c"># Compute gradient quantities</span>
        <span class="n">shear</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="n">T2grad</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shp</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="n">shp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">shear</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">len1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">/</span> <span class="n">N</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
                <span class="n">len2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">/</span> <span class="n">N</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
                <span class="n">hyp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">len1</span><span class="p">,</span><span class="n">len2</span><span class="p">))</span>
                <span class="c"># In kilometres:</span>
                <span class="n">shear</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">wind_slice</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">wind_slice</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">hyp</span><span class="p">))</span><span class="o">*</span><span class="mf">1000.0</span>
                <span class="n">T2grad</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">T2_slice</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">T2_slice</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">hyp</span><span class="p">))</span><span class="o">*</span><span class="mf">1000.0</span>
                <span class="c"># N.W.DX</span>

        <span class="c"># pdb.set_trace()</span>

        <span class="c"># Go from B to A</span>
        <span class="c"># Find first location where T2 drops and shear is ?</span>

        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="c">### METHOD 1: USING THRESHOLDS</span>
            <span class="c"># By default</span>
            <span class="n">gfidx</span> <span class="o">=</span> <span class="n">shp</span><span class="o">/</span><span class="mi">2</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">shp</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">shear</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">T2grad</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">2.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="mf">2.0</span><span class="p">):</span>
                    <span class="n">gfidx</span> <span class="o">=</span> <span class="n">n</span>
                    <span class="k">break</span>

        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>

            <span class="c">### METHOD 2: FINDING MAX GRADIENTS AND AVERAGING</span>
            <span class="n">shear</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">shear</span><span class="p">)</span>
            <span class="n">T2grad</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">T2grad</span><span class="p">)</span>

            <span class="n">xsh_idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">shear</span> <span class="o">==</span> <span class="n">shear</span><span class="o">.</span><span class="n">max</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xtg_idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">T2grad</span> <span class="o">==</span> <span class="n">T2grad</span><span class="o">.</span><span class="n">max</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Max shear loc: {0} ... max tempgrad loc: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xsh_idx</span><span class="p">,</span><span class="n">xtg_idx</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">gfidx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">xsh_idx</span> <span class="o">+</span> <span class="n">xtg_idx</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gfidx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">xsh_idx</span><span class="p">,</span><span class="n">xtg_idx</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">gfidx</span>
        <span class="c"># maxshearloc[0][0] returns the integer</span>
</div>
<div class="viewcode-block" id="WRFOut.compute_frontogenesis"><a class="viewcode-back" href="../../../../WEM.postWRF.postWRF.html#WEM.postWRF.postWRF.wrfout.WRFOut.compute_frontogenesis">[docs]</a>    <span class="k">def</span> <span class="nf">compute_frontogenesis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">level</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note that all variables fetched with self.get have been</span>
<span class="sd">        destaggered and are at the same location.</span>

<span class="sd">        Output:</span>
<span class="sd">        Front       :   Frontgenesis in Kelvin per second.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># import pdb; pdb.set_trace()</span>
        <span class="c">#ds = 1 # Number of grid point to compute horizontal gradient over</span>
        <span class="c">#dx = ds</span>
        <span class="c">#dy = ds</span>
        <span class="c">#dz = 1 # Normal for vertical</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="mi">15</span> <span class="c"># hPa to compute vertical gradients</span>
        <span class="n">tidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_idx</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tidx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tidx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrf_times</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="n">tidxs</span> <span class="o">=</span> <span class="p">(</span><span class="n">tidx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">tidx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">TH2</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dTdx</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dTdy</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dTdz</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">U</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">V</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">W</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">tidx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tidxs</span><span class="p">):</span>
                <span class="c"># Just assume surface</span>
                <span class="n">lvidx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">U</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;U10&#39;</span><span class="p">,{</span><span class="s">&#39;t&#39;</span><span class="p">:</span><span class="n">tidx</span><span class="p">})[</span><span class="mi">0</span><span class="p">,:,:]</span>
                <span class="n">V</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;V10&#39;</span><span class="p">,{</span><span class="s">&#39;t&#39;</span><span class="p">:</span><span class="n">tidx</span><span class="p">})[</span><span class="mi">0</span><span class="p">,:,:]</span>
                <span class="n">W</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;W&#39;</span><span class="p">,{</span><span class="s">&#39;t&#39;</span><span class="p">:</span><span class="n">tidx</span><span class="p">,</span> <span class="s">&#39;lv&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
                <span class="n">T</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">,{</span><span class="s">&#39;t&#39;</span><span class="p">:</span><span class="n">tidx</span><span class="p">,</span> <span class="s">&#39;lv&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]})[</span><span class="mi">0</span><span class="p">,:,:,:]</span>
                <span class="n">TH2</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;TH2&#39;</span><span class="p">,{</span><span class="s">&#39;t&#39;</span><span class="p">:</span><span class="n">tidx</span><span class="p">})[</span><span class="mi">0</span><span class="p">,:,:]</span>
                <span class="c"># Z[n] = self.get(&#39;Z&#39;,{&#39;t&#39;:tidx, &#39;lv&#39; :[0,1]})[0,:,:,:]</span>
                <span class="c"># We want gap between levels so not destaggered:</span>
                <span class="n">Z</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;PH&#39;</span><span class="p">][</span><span class="n">tidx</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:]</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s">&#39;PHB&#39;</span><span class="p">][</span><span class="n">tidx</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:,:])</span><span class="o">/</span><span class="n">mc</span><span class="o">.</span><span class="n">g</span>
                <span class="c"># Each grid point is DX km apart:</span>
                <span class="n">dTdx</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">dTdy</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">TH2</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span>

                <span class="c"># import pdb; pdb.set_trace()</span>
                <span class="n">levelgap</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">-</span> <span class="n">Z</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,:]</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">dTdz</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">/</span><span class="n">levelgap</span>
                <span class="c"># _, __, dTdz_2 = N.gradient(T[n])/levelgap</span>
                <span class="c"># N.gradient needs interpolating to one level here?</span>
                <span class="c"># dTdz[n] = (dTdz_2[1,...]-dTdz_2[0,...])/2.0</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="n">tidxs</span> <span class="o">=</span> <span class="p">(</span><span class="n">tidx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">tidx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="c"># Get sizes of array</span>
            <span class="n">ny</span><span class="p">,</span><span class="n">nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_p</span><span class="p">(</span><span class="s">&#39;U&#39;</span><span class="p">,</span><span class="n">tidx</span><span class="p">,</span><span class="n">level</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>

            <span class="c"># Initialise them</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">])</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
            <span class="c"># omega = N.zeros_like(U)</span>

            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tidxs</span><span class="p">):</span>
                <span class="n">U</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_p</span><span class="p">(</span><span class="s">&#39;U&#39;</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">level</span><span class="p">)</span>
                <span class="n">V</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_p</span><span class="p">(</span><span class="s">&#39;V&#39;</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">level</span><span class="p">)</span>
                <span class="n">W</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_p</span><span class="p">(</span><span class="s">&#39;W&#39;</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">level</span><span class="p">)</span>

                <span class="c"># 3D array has dimensions (vertical, horz, horz)</span>
                <span class="n">T</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_p</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="n">t</span><span class="p">,(</span><span class="n">level</span><span class="o">-</span><span class="n">dp</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">level</span><span class="o">+</span><span class="n">dp</span><span class="p">))</span>

                <span class="c"># Compute omega</span>
                <span class="c"># P = rho* R* drybulb</span>
                <span class="c"># drybulb = T/((P0/P)^(R/cp)</span>

            <span class="n">drybulb</span> <span class="o">=</span> <span class="mf">273.15</span> <span class="o">+</span> <span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="p">((</span><span class="mf">100000.0</span><span class="o">/</span><span class="p">(</span><span class="n">level</span><span class="o">*</span><span class="mf">100.0</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">R</span><span class="o">/</span><span class="n">mc</span><span class="o">.</span><span class="n">cp</span><span class="p">)))</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span><span class="o">*</span><span class="mf">100.0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="n">drybulb</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="o">-</span><span class="n">rho</span> <span class="o">*</span> <span class="n">mc</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">W</span>

            <span class="c"># Time difference in sec</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrf_times_epoch</span><span class="p">[</span><span class="n">tidx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">wrf_times_epoch</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span>
            <span class="n">dTdt</span><span class="p">,</span> <span class="n">dTdz</span><span class="p">,</span> <span class="n">dTdy</span><span class="p">,</span> <span class="n">dTdx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">dp</span><span class="o">*</span><span class="mf">100.0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
            <span class="c"># Gradient part</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="p">(</span><span class="n">dTdx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dTdy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="c"># Full derivative - value wrong for dgraddz here</span>
            <span class="n">dgraddt</span><span class="p">,</span> <span class="n">dgraddz</span><span class="p">,</span> <span class="n">dgraddy</span><span class="p">,</span> <span class="n">dgraddx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">dp</span><span class="o">*</span><span class="mf">100.0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
            <span class="c"># Full equation</span>
            <span class="n">Front</span> <span class="o">=</span> <span class="n">dgraddt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">*</span><span class="n">dgraddx</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">*</span><span class="n">dgraddy</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="c"># + omega[1,1,:,:]*dgraddz[1,1,:,:]</span>
        <span class="k">return</span> <span class="n">Front</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">.</a></h1>





<p>
<iframe src="http://ghbtns.com/github-btn.html?user=&repo=&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../WEM.html">WEM package</a></li>
</ul>


<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2014, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.6.1</a>
      
    </div>

    

    
  </body>
</html>